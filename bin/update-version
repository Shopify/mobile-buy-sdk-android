#! /usr/bin/env ruby

unless (new_version = ARGV[0])
  raise "missing version argument"
end

root = File.expand_path('..', __dir__)

gradle_properties = File.join(root, "MobileBuy", "buy3", "gradle.properties")

unless File.exist?(gradle_properties) && File.writable?(gradle_properties)
  raise "unable to open #{gradle_properties}"
end

gradle_properties_src = File.read(gradle_properties)

version_components = new_version.split('-').map(&:to_i)
current_components = gradle_properties_src
    .match(/VERSION_NAME=([0-9.]+)/i)
    .captures[0].split('.').map(&:to_i)

patch = (version_components[0] > current_components[0]) || (version_components[1] > current_components[1]) ? 0 : current_components[2] + 1

updated_components = [
    version_components[0],
    version_components[1],
    patch
]

new_version = updated_components.join('.')

gradle_properties_src.gsub!(/VERSION_NAME=.*$/, "VERSION_NAME=#{new_version}")

File.open(gradle_properties, "w") do |file|
    file.puts gradle_properties_src
end
